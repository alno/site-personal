<h2>Установка и использование</h2>

<p>
Для работы плагина (в частности истории страниц) необходимо наличие гема <tt>diff-lcs</tt>. Для форматирования по умолчанию используется <tt>RedCloth</tt>, однако можно выбрать и другой форматтер. Таким образом:
</p>

<r:code lang="bash">
gem install diff-lcs RedCloth
</r:code>

<p>
Для установки плагина достаточно выполнить в директории Rails-приложения:
</p>

<r:code lang="bash">
script/plugin install git://github.com/alno/irwi
</r:code>

<p>
После установки необходимо сгенерировать миграцию, моделиь и контроллер... <b>Стойте, это вовсе не значит, что у вас в приложении появится куча чужого кода, который непонятно как поддерживать!</b> Контроллер и модель содержат всего по одной строке вида <tt>acts_as_*</tt> и генерируется для того, чтобы в последствии Вам было бы проще расширять функциональность. Вся собственная функциональность вики реализуется в файлах плагина, что позволяет безболезненно обновлять ее.
</p>

<p>
Итак, чтобы сгенерировать необходимые файлы необходимо вызвать соответсвующий генератор:
</p>

<r:code lang="bash">
script/generate irwi_wiki
</r:code>

<p>
После вызова генератора в приложение будут произведены следующие изменения:
</p>

<ul>
  <li>Добавлен WikiPageController и соответствующий хелпер для обработки страниц</li>
  <li>Добавлены модели WikiPage и WikiPageVersion для представления страниц</li>
  <li>Будет сгенерирована миграция, создающая таблицы в БД</li>
</ul>

<p>
Также в роуты будет добавлена следующая строка:
</p>

<r:code lang="ruby">
  map.wiki_root '/wiki'
</r:code>

<p>
Как несложно догадаться, в ней указывается корень wiki в вашем приложении. Вы можете легко его изменить на тот, который Вам больше нравится.
</p>

<p>
Все, работающая вики в вашем приложении сгенерирована. В принципе, можно уже использовать ее, но наверное вам все-таки хотелось бы изменить некоторые ее аспекты под свое приложение, например, изменить шаблоны, используемые для отображения или привязать ее к своей системе пользователей и ограничить права на редактирование страниц. Об этом и пойдет речь далее.
</p>

<h2>Изменение внешнего вида</h2>

<p>
Изменение внешнего вида можно производить двумя путями:
</p>

<ul>
  <li>Замена шаблонов</li>
  <li>Замена стилей в дефолтных шаблонах</li>
</ul>

<p>
Для замены какого-то шаблона (включая partial'ы) необходимо определить шаблон с соответствующим именем в директории видов для вашего контроллера. Ничего необычного, правда? Если вы не знаете, что же туда писать, можете посмотреть на дефолтные шаблоны в исходниках плагина (они там в app/views), благо они крайне простые.
</p>

<p>
Скорее всего, вы будете применять первый способ, но о первом все же стоит упомянуть. По умолчанию в каждый дефолтный шаблон добавляется CSS с описанием дефолтного стиля. Наверное, вам захочется его выкинуть (и подключить свой собственный в layout'е). Для этого достаточно переопределить в хелпере метод <tt>wiki_page_style</tt> своим, который возвращает пустую строку. Таким образом вы просто уберете стили из страниц.
</p>

<h2>Привязка к пользователям</h2>

<p>
Что необходимо для того, чтобы привязать вики к существующей системе пользователей в приложении?
</p>

<p>
Самый простой случай, если модель вашего пользователя называется User и у вас в контроллере определен метод current_user, который возвращает текущего пользователя. Согласитесь, это достаточно распространенный случай. В этом случае вики автоматически привяжется к пользователям и считать текущего пользователя автором изменений.
</p>

<p>
Единственная проблема - на всех страницах имя пользователя будет отображаться как-нибудь вроде <b>User123</b>. Наверное, это все-таки не то, что вы хотите. Чтобы исправить эту ситуацию достаточно определить метод <tt>wiki_user</tt> в классе WikiPagesHelper. Например, следующим образом:
</p>

<r:code lang="ruby">
module WikiPagesHelper
  include Irwi::Helpers::WikiPagesHelper

  def wiki_user( user )
    user ? link_to( user.login, user_path( user ) ) : "Guest"
  end

end
</r:code>

<p>
Если же ваша модель называется как-то по-другому, придется добавить еще одну строчку при инициализации приложения:
</p>

<r:code lang="ruby">
Irwi.config.user_class_name = 'Account' # Разумеется, если ваша модель называется именно так
</r:code>

<p>
Я рекомендую для этого создать отдельный initializer, чтобы потом туда же добавлять и прочие опции, которые вы, быть может захотите установить, но в принципе, вы вольны поступать как вам хочется.
</p>

<h2>Ограничение прав на выполнение операций</h2>

<p>
Скорее всего, Вам захочется добавить ограничение прав на просмотр или редактирование страниц вики (вообще говоря, я считаю, что это весьма неплохая идея). Например, как минимум, дать права на редактирование только зарегистрированным пользователям.
</p>

<p>
Для этого необходимо всего-навсего переопределить в контроллере три метода, осуществляющие проверку прав: <tt>show_allowed?</tt>, <tt>history_allowed?</tt> и <tt>edit_allowed?</tt>. В каждом из методов необходимо проверить имеет ли текущий пользователь права на совершение действия (просмотр, просмотр истории, редактирование) с текущей страницей (<tt>@page</tt>) и соответственно вернуть что-то, что расценивается как исттина или как ложь. В случае, если соответствующий метод возвращает ложь, то действие не совершается и в контроллере вызывается метод <tt>not_allowed</tt>, который по умолчанию рендерит текст об ошибке, но скорее всего вам захочется переопределить и его (например, чтобы редиректить пользователя на страницу логина).
</p>

<p>
Таким образом, примерный код контроллера может выглядеть следующим образом:
</p>

<r:code lang="ruby">
class WikiPagesController < ApplicationController

  acts_as_wiki_pages_controller

  def show_allowed?
    true # Показывать всем
  end

  def history_allowed?
    true # И историю пусть все смотрят
  end

  def edit_allowed?
    current_user # А редактируют только те, кто залогинены
  end

  def not_allowed
    redirect_to login_path # Всех нарушителей редиректим на страницу логина
  end

end
</r:code>

<h2>Итого</h2>

<p>
Я вкратце описал использование своего плагина для вики в Rails. Некоторые моменты, конечно, остались за границами этой статьи, но я опишу их позже. Приветствуются всякие замечания, предложения и идеи (через комменты, github, или любые мои контакты), а также патчи и форки (если кто-то хочет добавить что-то в плагин).
</p>
